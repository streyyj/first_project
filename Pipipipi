# fcplay_mod.py

from telethon import events, Button
from .. import loader, utils

@loader.tds
class FootCardPlayMod(loader.Module):
    """Auto-play match in FootCardBot (@F_CardBot)"""

    strings = {
        "name": "FootCardAutoMatch"
    }

    async def client_ready(self, client, db):
        self.client = client

    @loader.unrestricted
    async def fcplaycmd(self, message):
        """
        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .fcplay
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ¬´–ú–µ–Ω—é¬ª, –∫–ª–∏–∫–∞–µ—Ç ¬´‚öΩÔ∏è –ú–∞—Ç—á¬ª –∏ –∑–∞—Ç–µ–º ¬´üéÆ –ò–≥—Ä–∞—Ç—å –º–∞—Ç—á¬ª —É –±–æ—Ç–∞ @F_CardBot.
        """
        chat = await message.get_chat()
        chat_id = chat.id

        # 1) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "–ú–µ–Ω—é"
        sent = await self.client.send_message(chat_id, "–ú–µ–Ω—é")
        await utils.sleep(0.1)  # –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É

        # 2) –ñ–¥—ë–º –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç @F_CardBot
        try:
            resp = await self.client.wait_event(
                events.NewMessage(
                    chats=chat_id,
                    from_users="F_CardBot"  # username –±–æ—Ç–∞ –±–µ–∑ @
                ),
                timeout=5  # –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç –∑–∞ 5 —Å–µ–∫—É–Ω–¥, –≤—ã—Ö–æ–¥–∏–º
            )
        except Exception:
            await message.edit("‚ùóÔ∏è –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç @F_CardBot –ø–æ—Å–ª–µ ¬´–ú–µ–Ω—é¬ª.")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –±–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–æ–±—â–∞–µ–º
        if not getattr(resp, "buttons", None):
            await message.edit("‚ùóÔ∏è –û—à–∏–±–∫–∞: —É –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ—Ç inline-–∫–Ω–æ–ø–æ–∫.")
            return

        # 3) –ò—â–µ–º –∫–Ω–æ–ø–∫—É "‚öΩÔ∏è –ú–∞—Ç—á" –∏ –∫–ª–∏–∫–∞–µ–º
        found_match = False
        for row in resp.buttons:
            for btn in row:
                if btn.text == "‚öΩÔ∏è –ú–∞—Ç—á":
                    await resp.click(text="‚öΩÔ∏è –ú–∞—Ç—á")
                    found_match = True
                    break
            if found_match:
                break

        if not found_match:
            await message.edit("‚ùóÔ∏è –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ ¬´‚öΩÔ∏è –ú–∞—Ç—á¬ª —É –±–æ—Ç–∞.")
            return

        # 4) –ñ–¥—ë–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–±–æ—Ç –∏–∑–º–µ–Ω–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É)
        try:
            edited = await self.client.wait_event(
                events.MessageEdited(
                    chats=chat_id,
                    from_users="F_CardBot",
                    msg_id=resp.id
                ),
                timeout=5
            )
        except Exception:
            await message.edit("‚ùóÔ∏è –û—à–∏–±–∫–∞: –Ω–µ –¥–æ–∂–¥–∞–ª–∏—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ ¬´‚öΩÔ∏è –ú–∞—Ç—á¬ª.")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
        if not getattr(edited, "buttons", None):
            await message.edit("‚ùóÔ∏è –û—à–∏–±–∫–∞: —É –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ—Ç inline-–∫–Ω–æ–ø–æ–∫.")
            return

        # 5) –ò—â–µ–º –∫–Ω–æ–ø–∫—É "üéÆ –ò–≥—Ä–∞—Ç—å –º–∞—Ç—á" –∏ –∫–ª–∏–∫–∞–µ–º
        found_play = False
        for row in edited.buttons:
            for btn in row:
                if btn.text == "üéÆ –ò–≥—Ä–∞—Ç—å –º–∞—Ç—á":
                    await edited.click(text="üéÆ –ò–≥—Ä–∞—Ç—å –º–∞—Ç—á")
                    found_play = True
                    break
            if found_play:
                break

        if not found_play:
            await message.edit("‚ùóÔ∏è –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ ¬´üéÆ –ò–≥—Ä–∞—Ç—å –º–∞—Ç—á¬ª —É –±–æ—Ç–∞.")
            return

        # –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –æ–±–∞ –∫–ª–∏–∫–∞
        await message.delete()  # –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —á–∞—Ç
